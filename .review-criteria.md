# PyREPL3 Review Criteria

Project-specific review criteria for the PyREPL3 subprocess-isolated Python execution service.

<architecture>
## Architecture Requirements
- Maintain strict separation between protocol, session, subprocess, and API layers
- All background operations must use asyncio.Event - no polling loops
- User code runs in threads, infrastructure must remain async
- Single-reader invariant: only one execution per session at a time
- Event-driven patterns only (except hybrid health check baseline)
</architecture>

<concurrency>
## Concurrency & Threading
- Never hold locks during expensive operations (subprocess creation, I/O)
- Use placeholder reservation pattern for pool operations
- Thread-safe async bridge for user code execution
- Use asyncio.Queue for async producer/consumer patterns
- call_soon_threadsafe for thread-to-async communication
</concurrency>

<session-management>
## Session Management
- Sessions must track state with proper transitions
- Use async with session._state_lock for state changes
- Always check session.state before operations
- Handle TERMINATED state gracefully
- Session reuse is mandatory - each Session() creates new subprocess
</session-management>

<message-protocol>
## Message Protocol Requirements
- All messages inherit from BaseMessage with id and timestamp
- Use MessageType enum for type field
- Messages serialized with MessagePack (fallback to JSON)
- 4-byte length prefix for framing
- Correlation IDs must be maintained (e.g., InputMessage.id â†’ InputResponseMessage.input_id)
</message-protocol>

<performance>
## Performance Guidelines
- Subprocess creation takes 50-100ms minimum - account for this
- Output streaming latency should be <10ms
- Use flush sentinels for output ordering
- Event-driven patterns reduce CPU usage by >99%
- Session pool should maintain warm sessions to avoid startup delay
</performance>

<error-handling>
## Error Handling & Cancellation
- Two-tier cancellation: cooperative via sys.settrace, hard via worker restart
- Never use dont_inherit=True in compile() - breaks cancellation
- Check cancellation event on each line/call (100 check interval)
- Always allow for cleanup in cooperative cancellation
- Input handling must respond with correct correlation ID
</error-handling>

<testing>
## Testing Requirements
- Default to session reuse in tests (new Session() needs justification)
- Start background tasks explicitly (transport.start(), pool.start())
- Handle InputMessage in execute loops with proper response
- Allow for subprocess startup time (minimum 50-100ms)
- Use fixtures from tests/fixtures/ for consistency
</testing>

<security>
## Security Considerations
- Never expose or log secrets and keys
- Validate all inputs before execution
- Namespace isolation between executions
- Transaction support for rollback capability
- Source tracking for executed code
</security>

<documentation>
## Documentation Standards
- Document state transitions clearly
- Include timing expectations in comments
- Document lock usage and scope
- Explain event-driven patterns used
- Note any deviation from standard async patterns
</documentation>