name: PR Multi-Model Review (HITL, self-hosted)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:  # Allow manual trigger for testing

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: self-hosted
    if: github.event.pull_request.draft == false  # Skip draft PRs
    env:
      # Environment variable overrides (mapped via env.mapping.json)
      TEST_CMD: ${{ vars.TEST_CMD }}                      # Testing command
      REVIEW_TIMEOUT: ${{ vars.REVIEW_TIMEOUT }}          # Global timeout
      CLAUDE_MODEL: ${{ vars.CLAUDE_MODEL }}              # Claude model override
      CODEX_REASONING: ${{ vars.CODEX_REASONING }}        # Codex reasoning level
      GEMINI_MODEL: ${{ vars.GEMINI_MODEL }}              # Gemini model override
      REVIEW_PARALLEL: ${{ vars.REVIEW_PARALLEL }}        # Parallel execution
      GH_TOKEN: ${{ github.token }}                       # GitHub CLI token
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Claude Authentication
        run: |
          # Extract Claude OAuth token from macOS Keychain
          # The token is stored by Claude.ai/Max login, not API key
          export ANTHROPIC_AUTH_TOKEN="$(security find-generic-password -s 'Claude Code-credentials' -w 2>/dev/null || echo '')"
          
          # Ensure we're NOT using API key (we want Max/Pro subscription)
          unset ANTHROPIC_API_KEY
          
          # Export for subsequent steps
          echo "ANTHROPIC_AUTH_TOKEN=$ANTHROPIC_AUTH_TOKEN" >> "$GITHUB_ENV"
          echo "ANTHROPIC_API_KEY=" >> "$GITHUB_ENV"
          
          # Verify token was extracted
          if [ -z "$ANTHROPIC_AUTH_TOKEN" ]; then
            echo "::warning::Could not extract Claude token from Keychain. Claude review may fail."
          else
            echo "✓ Claude OAuth token extracted from Keychain"
          fi

      - name: Ensure Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Guardrails (auth + no API keys + CLIs present)
        run: |
          # Ensure Claude Code is in PATH if installed in non-standard location
          if [ -x "$HOME/.claude/local/claude" ]; then
            export PATH="$HOME/.claude/local:$PATH"
          fi
          
          # Skip Claude auth check if we're using ANTHROPIC_AUTH_TOKEN
          if [ -n "$ANTHROPIC_AUTH_TOKEN" ]; then
            echo "✓ Using Claude OAuth token from Keychain (Max/Pro subscription)"
            # Run auth check but allow Claude to fail since we handle it via token
            bash .review-pipeline/scripts/auth-check.sh || true
          else
            bash .review-pipeline/scripts/auth-check.sh
          fi

      - name: Validate configuration
        run: |
          cd .review-pipeline
          npm install --no-audit --no-fund
          node lib/config-loader.js validate || echo "Warning: Configuration validation failed, using defaults"

      - name: Build review context
        shell: bash
        id: context
        run: |
          set -euo pipefail
          mkdir -p .review-pipeline/workspace/context .review-pipeline/workspace/reports
          # PR metadata
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            gh pr view ${{ github.event.pull_request.number }} --json number,state,headRefName,baseRefName,headRefOid,permalink,author --repo "${{ github.repository }}" > .review-pipeline/workspace/context/pr.json
          else
            # Manual workflow_dispatch fallback
            echo '{"repo":"'${{ github.event.repository.name }}'","number":0,"head_sha":"'${{ github.sha }}'","branch":"'${{ github.ref_name }}'","link":"manual"}' > .review-pipeline/workspace/context/pr.json
          fi
          # Diff & files
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            gh pr diff ${{ github.event.pull_request.number }} --patch --repo "${{ github.repository }}" > .review-pipeline/workspace/context/diff.patch
            gh pr view ${{ github.event.pull_request.number }} --json files --repo "${{ github.repository }}" | jq -r '.files[].path' > .review-pipeline/workspace/context/files.txt
          else
            # Manual trigger - use git diff
            git diff HEAD~1 > .review-pipeline/workspace/context/diff.patch || git diff --cached > .review-pipeline/workspace/context/diff.patch || echo "No diff available" > .review-pipeline/workspace/context/diff.patch
            git diff --name-only HEAD~1 > .review-pipeline/workspace/context/files.txt || git diff --name-only --cached > .review-pipeline/workspace/context/files.txt || echo "No files changed" > .review-pipeline/workspace/context/files.txt
          fi
          # Get test command from configuration or environment
          TEST_CMD="${TEST_CMD:-$(node .review-pipeline/lib/config-loader.js show 2>/dev/null | jq -r '.testing.command // "pytest tests/"' || echo 'pytest tests/')}"
          
          # Optional tests
          if [ -n "${TEST_CMD}" ]; then
            set +e
            echo "\$ ${TEST_CMD}" > .review-pipeline/workspace/context/tests.txt
            timeout 300 bash -c "${TEST_CMD}" >> .review-pipeline/workspace/context/tests.txt 2>&1
            echo "== exit:$? ==" >> .review-pipeline/workspace/context/tests.txt
            set -e
          fi

      - name: Provider reviews (configuration-based)
        shell: bash
        timeout-minutes: 5  # Prevent hanging reviews
        run: |
          set -euo pipefail
          cd .review-pipeline
          
          # Ensure Claude Code is in PATH if installed in non-standard location
          if [ -x "$HOME/.claude/local/claude" ]; then
            export PATH="$HOME/.claude/local:$PATH"
          fi
          
          # Unset any API key envs to prevent metered billing
          unset ANTHROPIC_API_KEY OPENAI_API_KEY GEMINI_API_KEY
          
          # Get configuration settings
          PARALLEL_ENABLED=$(node lib/config-loader.js show 2>/dev/null | jq -r '.execution.parallel // true' || echo 'true')
          GLOBAL_TIMEOUT=$(node lib/config-loader.js show 2>/dev/null | jq -r '.execution.timeout_seconds // 120' || echo '120')
          
          # Get enabled providers
          ENABLED_PROVIDERS=$(node -e "
            import('./lib/config-loader.js').then(async (module) => {
              const ConfigLoader = module.default;
              const loader = new ConfigLoader();
              await loader.load();
              console.log(loader.getEnabledProviders().join(' '));
            }).catch(() => console.log('claude codex gemini'));
          " 2>/dev/null || echo 'claude codex gemini')
          
          echo "Configuration:"
          echo "  Parallel: $PARALLEL_ENABLED"
          echo "  Timeout: $GLOBAL_TIMEOUT seconds"
          echo "  Enabled providers: $ENABLED_PROVIDERS"
          
          # Run provider reviews based on configuration
          run_provider() {
            local provider="$1"
            local timeout="${2:-$GLOBAL_TIMEOUT}"
            
            # Check if provider is enabled
            local enabled=$(node -e "
              import('./lib/config-loader.js').then(async (module) => {
                const ConfigLoader = module.default;
                const loader = new ConfigLoader();
                await loader.load();
                console.log(loader.isProviderEnabled('$provider'));
              }).catch(() => console.log('true'));
            " 2>/dev/null || echo 'true')
            
            if [ "$enabled" != "true" ]; then
              echo "Skipping $provider (disabled)"
              return 0
            fi
            
            # Get provider-specific timeout if configured
            timeout=$(node -e "
              import('./lib/config-loader.js').then(async (module) => {
                const ConfigLoader = module.default;
                const loader = new ConfigLoader();
                await loader.load();
                const config = loader.getProviderConfig('$provider');
                console.log(config.timeout);
              }).catch(() => console.log('$timeout'));
            " 2>/dev/null || echo "$timeout")
            
            echo "Running $provider review (timeout: ${timeout}s)..."
            bash scripts/run-provider-review.sh "$provider" "$timeout" || true
          }
          
          # Execute reviews based on parallel configuration
          if [ "$PARALLEL_ENABLED" = "true" ]; then
            echo "Running reviews in parallel..."
            for provider in $ENABLED_PROVIDERS; do
              run_provider "$provider" &
            done
            wait
          else
            echo "Running reviews sequentially..."
            for provider in $ENABLED_PROVIDERS; do
              run_provider "$provider"
            done
          fi
          
          # Verify reports were created for enabled providers
          for provider in $ENABLED_PROVIDERS; do
            report_file="workspace/reports/${provider}-$([ "$provider" = "claude" ] && echo "code" || echo "cli").json"
            if [ ! -f "$report_file" ]; then
              echo "::warning::Missing report: $report_file"
            fi
          done

      - name: Aggregate & gate
        shell: bash
        run: |
          cd .review-pipeline && npm install --no-audit --no-fund
          node scripts/aggregate-reviews.mjs || echo "Warning: Aggregation had issues, check reports"

      - name: Attach summary as PR comment
        if: always() && github.event.pull_request.number != ''
        shell: bash
        run: |
          if [ -f .review-pipeline/workspace/summary.md ]; then
            # Check if we already commented on this SHA
            existing_comments=$(gh pr view ${{ github.event.pull_request.number }} --json comments --repo "${{ github.repository }}" | jq -r '.comments[].body' | grep -c "SHA: ${{ github.event.pull_request.head.sha }}" || true)
            if [ "$existing_comments" -eq 0 ]; then
              echo "<!-- Multi-Model Review SHA: ${{ github.event.pull_request.head.sha }} -->" >> .review-pipeline/workspace/summary.md
              gh pr comment ${{ github.event.pull_request.number }} --body-file .review-pipeline/workspace/summary.md --repo "${{ github.repository }}"
            else
              echo "Already commented on this SHA, skipping duplicate."
            fi
          else
            echo "::warning::No summary generated"
          fi

      - name: Fail if gate failed
        shell: bash
        run: |
          if [ -f .review-pipeline/workspace/gate.txt ]; then
            gate_status="$(cat .review-pipeline/workspace/gate.txt)"
            echo "Gate status: $gate_status"
            if [ "$gate_status" = "fail" ]; then
              echo "::error::Review gate failed - must-fix issues found"
              exit 1
            fi
          else
            echo "::warning::No gate status file found"
          fi